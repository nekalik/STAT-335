---
title: "STAT 335 Project Phase 2"
author: "Shan Sun, Faith Wong"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Phase 1

```{r}
# loading time series packages
library(xts)
library(astsa)
```

## Data

```{r}
# reading in csv file to R as "delays" dataframe
delays <- read.csv("Airline_Delay_Cause.csv")
```

```{r}
# first look at data
str(delays)
head(delays)
```

## Data description

The dataset describes U.S. flight delays from January 2017 - July 2022. Some variables included are the year and month of data collection, airline carrier, airport, the number of flights delayed due to a specific reason (air carrier, weather, National Aviation System, security issue, previous flight delayed), and the total time (minutes) of delay due to a specific reason.

The data was found on Kaggle.com:

Jawad Khattak, 2022. *"Flight Delay from January 2017 - July 2022."* Kaggle.com, https://www.kaggle.com/datasets/jawadkhattak/us-flight-delay-from-january-2017-july-2022.

The original source of the Kaggle.com data:

U.S. Department of Transportation: Bureau of Transportation Statistics (BTS), 2022. *"Airline On-Time Statistics and Delay Causes."* BTS website, https://www.transtats.bts.gov/OT_Delay/OT_DelayCause1.asp.

## Research question

**What is the relationship between the month and the number and nature of delays?**

For example:

Do the primary causes of delays vary from month to month? Is there a dominant reason that causes the most delays? Are certain months associated with a certain kind of delay? How does the month impact how many total delays there are?

# Phase 2

```{R}
delays$date = as.Date(paste(delays$year, delays$month, 1, sep = "-"))
head(delays)
```

```{R}
totime = aggregate(arr_delay~date, delays,mean )
head(totime)
tsplot(totime$date, totime$arr_delay)

lm = lm(arr_delay~date, data = totime)
summary(lm)

```

```{R}
w = rnorm(n = 400, mean= 5000, sd = 1) # 50 extra to avoid startup problems
x = filter(w, filter=c(1.7,-.70), 
           method="recursive")[-(1:100)]
tsplot(x, main="autoregression", col=4)
```

```{R}
acf(totime$arr_delay)
acf1(totime$arr_delay, max.lag = 48)
```

```{R}
numflight = aggregate(arr_del15~date, delays,sum)
head(numflight)
tsplot(numflight$date, numflight$arr_del15)

```


```{R}
# removing categorical columns
sub_delays = delays[-(3:6)]
head(delays)
head(sub_delays)
# finding mean of each column by date
summary_delays= aggregate(.~date, sub_delays,mean)
head(summary_delays)
# isolating data to pre-Covid only (January 2017-December 2019)
summary_delays = summary_delays[summary_delays$date<'2020-01-01', ]
```

```{R}

ts.plot(summary_delays)
ts.plot(summary_delays[4:18])
```

```{R}
trend = lm(arr_flights~date, data = summary_delays)
summary(trend)
tsplot(summary_delays$date, summary_delays$arr_flights)
abline(trend,col="red")
par(mfrow=c(2,2)) 
plot(trend)
```

```{R}
#Check hetero and does not help
test = lm(log(arr_flights)~date, data = summary_delays)
summary(test)

tsplot(summary_delays$date, log(summary_delays$arr_flights))
abline(test,col="red")

par(mfrow=c(2,2)) 
plot(test)
```

```{R}
library(corrplot)
corrplot(cor(summary_delays[-(1:3)]))
```

```{R}
#detrending
tsplot(resid(trend))
acf1(resid(trend),30)


```

```{R}

#differencing
tsplot(diff(summary_delays$arr_flights))
acf1(diff(summary_delays$arr_flights),30)

```




