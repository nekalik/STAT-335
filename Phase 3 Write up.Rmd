---
title: "Final Report"
author: "Shan Sun, Faith Wong"
date: "STAT 335, Fall 2023"
output: pdf_document
fontsize: 12pt
header-includes:
  - \usepackage[margin=1in]{geometry}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

<!-- An introduction to the data and the problem would be a very good way to start. -->

The dataset describes U.S. flight delays from January 2017 - July 2022. Some variables included are the year and month of data collection, airline carrier, airport, the number of flights delayed due to a specific reason (air carrier, weather, National Aviation System, security issue, previous flight delayed), and the total time (minutes) of delay due to a specific reason.

We want to

## The Research Question

<!-- Clearly state your SINGLE RESEARCH QUESTION -->

We

Research Question: **What is the relationship between the both and the number of delays**

## Analysis

<!-- Your analysis goes here.  -->

<!-- Be sure to carefully select the plots and graphics that best support your analysis and conclusion. -->

### Data Organization

Before we did any analysis, we began by loading the data and manipulating it into a format we can use. We created a column for dates, removed categorical variables, and aggregated the data for each month.

```{r, results='hide', warning=FALSE}
# setup
library(astsa)
delays <- read.csv("https://raw.githubusercontent.com/nekalik/STAT-335-Project/main/Airline_Delay_Cause.csv")

# formatting dates
delays$date = as.Date(paste(delays$year, delays$month, 1, sep = "-"))

# removing categorical variables
sub_delays = delays[-(3:6)]

# sum to aggregate
sum_delays= aggregate(.~date, sub_delays,sum)
```

### Data Exploration

```{r}
# total number of delays
tsplot(x=sum_delays$date,y=sum_delays$arr_del15)
```

COVID has a large impact on flights, so a data frame was created exclusively for pre-COVID data.

```{r}
# pre-COVID data
sum_delays_pre = sum_delays[sum_delays$date<'2020-01-01', ]
```

For now, we focused on the number of delayed flights ("arr_del15") before COVID. To begin, the delays over time was plotted.

```{r}
# variable to focus on
x = sum_delays_pre$arr_del15

xx = sum_delays_pre$date

# time series plot
tsplot(x=xx, y=x)
```

Before 2020, it appears that there's a linear trend, so we fit a linear regression model.

### Linear Regression

```{r}
lm.x = lm(x~sum_delays_pre$date)

plot(x=xx, y=x)
abline(lm.x)

summary(lm.x)

par(mfrow = c(2, 2))
plot(lm.x)
```

Clearly, the linear trend we observed previously is present and not due to randomness, because the regression model & parameter estimate are significant, and the residuals look relatively good. Also, there may be some nonconstant variance in the residual plot.

We will make use of these insights as we attempt to fit an ARIMA/SARIMA model.

### Model Building

We used our previous discoveries to guide us in model fitting. Since there's a linear trend, we differenced the data. In addition, we attempted to build some models with log(x) due to possible heteroscedasticity. 

From the time series plot of the number of delays vs time, there seems to be seasonality in the data. However, an error occurred when we tried $ARIMA_{x}(1,1,1) \times (0,1,1)_{12}$ model. The error could be caused by the lack of data. After removing the data after COVID, the data set is restricted to 36 points (2017-2020).

After examining the acf and pacf of x and log(x), we came up with the following models (shown in the table). For all of these models, the standardized residuals are white noise-like, ACF within the confidence bands, the Q-Q plot seems to be straight, and the p-values for the Ljung-Box statistic are above 0.05. The best white noise-like model is noted with ++. The AIC and AICc are close to each other, so we only included the AIC and BIC in the table.


```{=tex}
\begin{table}[]
\begin{tabular}{|l|l|l|l|l|}
\hline
Model                   &  AIC        & BIC         & Parameter Significance          & Residual   \\ \hline
$AR_x(1)$               & $22.6247$   &  22.7567    & significant                     &   +         \\ \hline
$MA_x(2)$               & $22.597 $   & 22.7730     & significant                     &   ++        \\ \hline
$ARIMA_x(0,1,2)$        & $22.7382$   & 22.9159     & significant                     &   -         \\ \hline
$ARIMA_{log(x)}(1,1,1)$ & $-0.1735$   & -0.0402     & ma1 not significant             &   +         \\ \hline
$MA_{log(x)}(2)$        & $-0.2596$   & -0.0837     & significant                     &   ++        \\ \hline
$ARIMA_{log(x)}(1,1,0)$ & $-0.1974$   & -0.1086     & significant                     &   +-        \\ \hline
\end{tabular}
\end{table}
```
### Model Selection

After carefully examining the residuals and the AIC, we believe $ARIMA_{log(x)}(1,1,1)$ is the best model for this data set since it has the smallest AIC and the best white-noise like residual. We performed a forecast with this data.

```{r, results='hide'}
sarima(log(x), p=0, d=0, q =2)
sar.log = sarima.for(log(x), p=0, d=0, q =2, n.ahead=24)
sar.log
```

### COVID

Since the trend in the data set was interrupted due to COVID, we like to forecast how would the data looks like if COVID didn't hit, and we would like to use prediction to see when the flights recover from COVID (the time where post-COVID data catch back to the forecast trend).

```{R}
prediction = sar.log$pred
tsplot(log(sum_delays$arr_del15), xlim=c(0,70), ylim=c(9,13),lty = 1, lwd=1)
lines(prediction, col=4, lty=2, lwd=1.5 )
legend(0,10, legend = c("actual", "forecast"), col=c(1,4), lty = c(1,2))
```

By plotting the forecast and the actual data on the same plot, we can see the actual data catch up to prediction around time 53 (May of 2021). We can see from the graph, the overall flow of the data seems to be smooth by replacing the cave due to COVID with the forecast. Even though, forecast does not shows a lot of fluctuation after the 10 prediction, it still give a general idea of where the delay would land, it COVID didn't hit.

This makes sense - COVID impacted number of flights.

```{r}
library(corrplot)
cor(sum_delays$arr_flights, sum_delays$arr_del15)

lm.ratio = lm(arr_del15~arr_flights, data = sum_delays)

plot(sum_delays$arr_flights, sum_delays$arr_del15)
abline(lm.ratio)
```

## Conclusion

<!-- Be sure to provide a clearly articulated answer to your research question that is well-supported by your analysis. -->

## References

<!-- I'm not picky about reference style but references should be accurate and complete. If you want a style guide, use this one: [IEEE Style Guide](https://ieee-dataport.org/sites/default/files/analysis/27/IEEE%20Citation%20Guidelines.pdf) -->

U.S. Department of Transportation: Bureau of Transportation Statistics (BTS), 2022. *"Airline On-Time Statistics and Delay Causes."* BTS website, <https://www.transtats.bts.gov/OT_Delay/OT_DelayCause1.asp>.

Jawad Khattak, 2022. *"Flight Delay from January 2017 - July 2022."* Kaggle.com, <https://www.kaggle.com/datasets/jawadkhattak/us-flight-delay-from-january-2017-july-2022>.
